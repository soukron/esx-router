global
  log         127.0.0.1 local2
  pidfile     /var/run/haproxy.pid
  maxconn     4000
  daemon

defaults
  mode                    http
  log                     global
  option                  dontlognull
  option                  http-server-close
  option                  redispatch
  retries                 3
  timeout http-request    10s
  timeout queue           1m
  timeout connect         10s
  timeout client          1m
  timeout server          1m
  timeout http-keep-alive 10s
  timeout check           10s
  maxconn                 3000

{% for vip in load_balancer_vips %}
{% set vip_name = vip.name | default(vip.hostname) %}
{% set vip_label = vip_name | regex_replace('[^A-Za-z0-9_-]', '-') %}
{% for port in vip.ports | default([]) %}
{% set port_config = port if port is mapping else {} %}
{% set port_number = port_config.port | default(port) %}
listen {{ vip_label }}-{{ port_number }}
  bind {{ vip.vip | default(load_balancer_bind_ip | default('*')) }}:{{ port_number }}
  mode {{ port_config.mode | default(vip.mode | default('tcp')) }}
  balance {{ port_config.balance | default(vip.balance | default('roundrobin')) }}
{% if port_config.options is defined %}
{% for option in port_config.options %}
  option {{ option }}
{% endfor %}
{% elif vip.options is defined %}
{% for option in vip.options %}
  option {{ option }}
{% endfor %}
{% endif %}
{% if port_config.httpchk is defined %}
  option httpchk {{ port_config.httpchk }}
{% elif vip.httpchk is defined %}
  option httpchk {{ vip.httpchk }}
{% endif %}
{% if port_config.log_health_checks | default(vip.log_health_checks | default(false)) %}
  option  log-health-checks
{% endif %}
{% set server_items = vip.backend_servers | default([]) %}
{% if server_items | length == 0 %}
{% for ip in vip.backend_ips | default([]) %}
  server backend{{ loop.index0 }} {{ ip }}:{{ port_number }} {{ port_config.server_options | default(vip.server_options | default('check inter 1s')) }}
{% endfor %}
{% else %}
{% for server in server_items %}
  server {{ server.name | default('backend' ~ loop.index0) }} {{ server.address }}:{{ port_number }} {{ server.options | default(port_config.server_options | default(vip.server_options | default('check inter 1s'))) }}
{% endfor %}
{% endif %}

{% endfor %}
{% endfor %}
